using System;
using System.Collections.Generic;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Threading;
using System.Threading.Tasks;
using Chromatics.CorsairLibs;
using CUE.NET;
using CUE.NET.Brushes;
using CUE.NET.Devices.Generic.Enums;
using CUE.NET.Groups;

/* Contains all Corsair SDK code for detection, initilization, states and effects.
 * 
 * 
 */

namespace Chromatics
{
    partial class Chromatics
    {
        private static readonly object _Corsairtransition = new object();

        private static readonly object _CorsairRipple1 = new object();

        private static readonly object _CorsairRipple2 = new object();

        private static readonly object _CorsairFlash1 = new object();

        private static readonly object _CorsairFlash2 = new object();


        private static readonly object _CorsairtransitionConst = new object();
        private ListLedGroup _CorsairAllHeadsetLED;

        //Define Corsair LED Groups
        private ListLedGroup _CorsairAllKeyboardLED;
        private ListLedGroup _CorsairAllMouseLED;
        private ListLedGroup _CorsairAllMousepadLED;
        private bool _CorsairFlash2Running;

        private int _CorsairFlash2Step;

        private KeyMapBrush _CorsairKeyboardIndvBrush;

        private ListLedGroup _CorsairKeyboardIndvLED;

        private readonly string[] _Corsairkeys =
        {
            "Y", "D5", "D6", "D7", "T", "U", "G", "H", "J", "F3", "F4", "F5", "F6",
            "F7", "D4", "D8", "R", "F", "C", "V", "B", "N", "M", "K", "I", "F2", "F8", "D3", "E", "D", "X", "Space",
            "OemComma", "L", "O", "D9", "F1", "F9", "D2", "D0", "W", "S", "Z", "LeftAlt", "P", "OemSemicolon",
            "OemPeriod", "RightAlt", "D1", "Q", "A", "LeftWindows", "F10", "OemMinus", "OemLeftBracket", "OemApostrophe",
            "OemSlash", "Function", "Escape", "OemTilde", "Tab", "CapsLock", "LeftShift", "LeftControl", "F11",
            "OemEquals", "RightMenu", "OemRightBracket", "Macro1", "Macro2", "Macro3", "Macro4", "Macro5", "F12",
            "Backspace", "OemBackslash", "Enter", "RightShift", "RightControl"
        };

        private string[] _Corsairkeys2 =
        {
            "Y", "D5", "D6", "D7", "T", "U", "G", "H", "J", "D4", "D8", "R", "F", "C", "V",
            "B", "N", "M", "K", "I", "D3", "E", "D", "X", "Space", "OemComma", "L", "O", "D9", "D2", "D0", "W", "S", "Z",
            "LeftAlt", "P", "OemSemicolon", "OemPeriod", "RightAlt", "D1", "Q", "A", "LeftWindows", "OemMinus",
            "OemLeftBracket", "OemApostrophe", "OemSlash", "Function", "Escape", "OemTilde", "Tab", "CapsLock",
            "LeftShift", "LeftControl", "OemEquals", "RightMenu", "OemRightBracket", "Macro1", "Macro2", "Macro3",
            "Macro4", "Macro5", "Backspace", "OemBackslash", "Enter", "RightShift", "RightControl"
        };

        private readonly string[] _Corsairkeys3 =
        {
            "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11",
            "F12", "NumLock", "Num0", "Num1", "Num2", "Num3", "Num4", "Num5", "Num6", "Num7", "Num8", "Num9",
            "NumDivide", "NumMultiply", "NumSubtract", "NumAdd", "NumEnter", "NumDecimal"
        };

        private KeyMapBrush _CorsairMouseIndvBrush;
        private ListLedGroup _CorsairMouseIndvLED;
        private KeyMapBrush _CorsairMousepadIndvBrush;
        private ListLedGroup _CorsairMousepadIndvLED;
        private readonly string[] _Corsairstep0 = {"Y"};
        private readonly string[] _Corsairstep1 = {"D5", "D6", "D7", "T", "U", "G", "H", "J"};

        private readonly string[] _Corsairstep2 =
        {
            "F3", "F4", "F5", "F6", "F7", "D4", "D8", "R", "F", "C", "V", "B",
            "N", "M", "K", "I"
        };

        private readonly string[] _Corsairstep3 = {"F2", "F8", "D3", "E", "D", "X", "Space", "OemComma", "L", "O", "D9"};

        private readonly string[] _Corsairstep4 =
        {
            "F1", "F9", "D2", "D0", "W", "S", "Z", "LeftAlt", "P", "OemSemicolon",
            "OemPeriod", "RightAlt"
        };

        private readonly string[] _Corsairstep5 =
        {
            "D1", "Q", "A", "LeftWindows", "F10", "OemMinus", "OemLeftBracket",
            "OemApostrophe", "OemSlash", "Function"
        };

        private readonly string[] _Corsairstep6 =
        {
            "Escape", "OemTilde", "Tab", "CapsLock", "LeftShift", "LeftControl",
            "F11", "OemEquals", "RightMenu", "OemRightBracket", "OemBackslash"
        };

        private readonly string[] _Corsairstep7 =
        {
            "Macro1", "Macro2", "Macro3", "Macro4", "Macro5", "F12", "Backspace",
            "Enter", "RightShift", "RightControl"
        };

        //Handle device send/recieve
        private readonly CancellationTokenSource CCTS = new CancellationTokenSource();
        private bool CorsairDeviceHeadset;
        private bool CorsairDeviceKeyboard;
        private bool CorsairDeviceKeypad;
        private bool CorsairDeviceMouse;
        private bool CorsairDeviceMousepad;

        private readonly Dictionary<string, CorsairLedId> Corsairkeyids = new Dictionary<string, CorsairLedId>
        {
            //Keys
            {"F1", CorsairLedId.F1},
            {"F2", CorsairLedId.F2},
            {"F3", CorsairLedId.F3},
            {"F4", CorsairLedId.F4},
            {"F5", CorsairLedId.F5},
            {"F6", CorsairLedId.F6},
            {"F7", CorsairLedId.F7},
            {"F8", CorsairLedId.F8},
            {"F9", CorsairLedId.F9},
            {"F10", CorsairLedId.F10},
            {"F11", CorsairLedId.F11},
            {"F12", CorsairLedId.F12},
            {"D1", CorsairLedId.D1},
            {"D2", CorsairLedId.D2},
            {"D3", CorsairLedId.D3},
            {"D4", CorsairLedId.D4},
            {"D5", CorsairLedId.D5},
            {"D6", CorsairLedId.D6},
            {"D7", CorsairLedId.D7},
            {"D8", CorsairLedId.D8},
            {"D9", CorsairLedId.D9},
            {"D0", CorsairLedId.D0},
            {"A", CorsairLedId.A},
            {"B", CorsairLedId.B},
            {"C", CorsairLedId.C},
            {"D", CorsairLedId.D},
            {"E", CorsairLedId.E},
            {"F", CorsairLedId.F},
            {"G", CorsairLedId.G},
            {"H", CorsairLedId.H},
            {"I", CorsairLedId.I},
            {"J", CorsairLedId.J},
            {"K", CorsairLedId.K},
            {"L", CorsairLedId.L},
            {"M", CorsairLedId.M},
            {"N", CorsairLedId.N},
            {"O", CorsairLedId.O},
            {"P", CorsairLedId.P},
            {"Q", CorsairLedId.Q},
            {"R", CorsairLedId.R},
            {"S", CorsairLedId.S},
            {"T", CorsairLedId.T},
            {"U", CorsairLedId.U},
            {"V", CorsairLedId.V},
            {"W", CorsairLedId.W},
            {"X", CorsairLedId.X},
            {"Y", CorsairLedId.Y},
            {"Z", CorsairLedId.Z},
            {"NumLock", CorsairLedId.NumLock},
            {"Num0", CorsairLedId.Keypad0},
            {"Num1", CorsairLedId.Keypad1},
            {"Num2", CorsairLedId.Keypad2},
            {"Num3", CorsairLedId.Keypad3},
            {"Num4", CorsairLedId.Keypad4},
            {"Num5", CorsairLedId.Keypad5},
            {"Num6", CorsairLedId.Keypad6},
            {"Num7", CorsairLedId.Keypad7},
            {"Num8", CorsairLedId.Keypad8},
            {"Num9", CorsairLedId.Keypad9},
            {"NumDivide", CorsairLedId.KeypadSlash},
            {"NumMultiply", CorsairLedId.KeypadAsterisk},
            {"NumSubtract", CorsairLedId.KeypadMinus},
            {"NumAdd", CorsairLedId.KeypadPlus},
            {"NumEnter", CorsairLedId.KeypadEnter},
            {"NumDecimal", CorsairLedId.KeypadPeriodAndDelete},
            {"PrintScreen", CorsairLedId.PrintScreen},
            {"Scroll", CorsairLedId.ScrollLock},
            {"Pause", CorsairLedId.PauseBreak},
            {"Insert", CorsairLedId.Insert},
            {"Home", CorsairLedId.Home},
            {"PageUp", CorsairLedId.PageUp},
            {"PageDown", CorsairLedId.PageDown},
            {"Delete", CorsairLedId.Delete},
            {"End", CorsairLedId.End},
            {"Up", CorsairLedId.UpArrow},
            {"Left", CorsairLedId.LeftArrow},
            {"Right", CorsairLedId.RightArrow},
            {"Down", CorsairLedId.DownArrow},
            {"Tab", CorsairLedId.Tab},
            {"CapsLock", CorsairLedId.CapsLock},
            {"Backspace", CorsairLedId.Backspace},
            {"Enter", CorsairLedId.Enter},
            {"LeftControl", CorsairLedId.LeftCtrl},
            {"LeftWindows", CorsairLedId.WinLock},
            {"LeftAlt", CorsairLedId.LeftAlt},
            {"Space", CorsairLedId.Space},
            {"RightControl", CorsairLedId.RightCtrl},
            {"Function", CorsairLedId.LeftGui},
            {"RightAlt", CorsairLedId.RightAlt},
            {"RightMenu", CorsairLedId.RightGui},
            {"LeftShift", CorsairLedId.LeftShift},
            {"RightShift", CorsairLedId.RightShift},
            {"Macro1", CorsairLedId.G1}, //G1
            {"Macro2", CorsairLedId.G2}, //G2
            {"Macro3", CorsairLedId.G3}, //G3
            {"Macro4", CorsairLedId.G4}, //G4
            {"Macro5", CorsairLedId.G5}, //G5
            {"Macro6", CorsairLedId.G6}, //G6
            {"Macro7", CorsairLedId.G7}, //G7
            {"Macro8", CorsairLedId.G8}, //G8
            {"Macro9", CorsairLedId.G9}, //G9
            {"Macro10", CorsairLedId.G10}, //G10
            {"Macro11", CorsairLedId.G11}, //G11
            {"Macro12", CorsairLedId.G12}, //G12
            {"Macro13", CorsairLedId.G13}, //G13
            {"Macro14", CorsairLedId.G14}, //G14
            {"Macro15", CorsairLedId.G15}, //G15
            {"Macro16", CorsairLedId.G16}, //G16
            {"Macro17", CorsairLedId.G17}, //G17
            {"Macro18", CorsairLedId.G18}, //G18
            {"OemTilde", CorsairLedId.GraveAccentAndTilde},
            {"OemMinus", CorsairLedId.MinusAndUnderscore},
            {"OemEquals", CorsairLedId.EqualsAndPlus},
            {"OemLeftBracket", CorsairLedId.BracketLeft},
            {"OemRightBracket", CorsairLedId.BracketRight},
            {"OemSlash", CorsairLedId.SlashAndQuestionMark},
            {"OemSemicolon", CorsairLedId.SemicolonAndColon},
            {"OemApostrophe", CorsairLedId.ApostropheAndDoubleQuote},
            {"OemComma", CorsairLedId.CommaAndLessThan},
            {"OemPeriod", CorsairLedId.PeriodAndBiggerThan},
            {"OemBackslash", CorsairLedId.Backslash},
            {"EurPound", CorsairLedId.International1},
            {"JpnYen", CorsairLedId.International2},
            {"Escape", CorsairLedId.Escape},
            {"MouseFront", CorsairLedId.B2},
            {"MouseScroll", CorsairLedId.B3},
            {"MouseSide", CorsairLedId.B4},
            {"MouseLogo", CorsairLedId.B1},
            {"Pad1", CorsairLedId.Zone1},
            {"Pad2", CorsairLedId.Zone2},
            {"Pad3", CorsairLedId.Zone3},
            {"Pad4", CorsairLedId.Zone4},
            {"Pad5", CorsairLedId.Zone5},
            {"Pad6", CorsairLedId.Zone6},
            {"Pad7", CorsairLedId.Zone7},
            {"Pad8", CorsairLedId.Zone8},
            {"Pad9", CorsairLedId.Zone9},
            {"Pad10", CorsairLedId.Zone10},
            {"Pad11", CorsairLedId.Zone11},
            {"Pad12", CorsairLedId.Zone12},
            {"Pad13", CorsairLedId.Zone13},
            {"Pad14", CorsairLedId.Zone14},
            {"Pad15", CorsairLedId.Zone15},
            {"Strip1", CorsairLedId.Invalid},
            {"Strip2", CorsairLedId.Invalid},
            {"Strip3", CorsairLedId.Invalid},
            {"Strip4", CorsairLedId.Invalid},
            {"Strip5", CorsairLedId.Invalid},
            {"Strip6", CorsairLedId.Invalid},
            {"Strip7", CorsairLedId.Invalid},
            {"Strip8", CorsairLedId.Invalid},
            {"Strip9", CorsairLedId.Invalid},
            {"Strip10", CorsairLedId.Invalid},
            {"Strip11", CorsairLedId.Invalid},
            {"Strip12", CorsairLedId.Invalid},
            {"Strip13", CorsairLedId.Invalid},
            {"Strip14", CorsairLedId.Invalid}
        };

        private Color CorsairLogo;
        private Color CorsairLogoConv;
        private Color CorsairPauseBrk;
        private Color CorsairPauseBrkConv;
        private Color CorsairPrintScr;

        private Color CorsairPrintScrConv;
        private Color CorsairScrollLk;
        private Color CorsairScrollLkConv;
        private Color CorsairScrollWheel;
        private Color CorsairScrollWheelConv;
        private Dictionary<string, Color> presets = new Dictionary<string, Color>();

        public void InitializeCorsairSDK()
        {
            WriteConsole(ConsoleTypes.CORSAIR, "Attempting to load CUE SDK..");

            try
            {
                CueSDK.Initialize();

                CorsairSDK = true;

                _CorsairKeyboardIndvBrush = new KeyMapBrush();
                _CorsairKeyboardIndvLED = new ListLedGroup(CueSDK.KeyboardSDK, CueSDK.KeyboardSDK);
                _CorsairAllKeyboardLED = new ListLedGroup(CueSDK.KeyboardSDK, CueSDK.KeyboardSDK);
                _CorsairAllKeyboardLED.ZIndex = 1;
                _CorsairKeyboardIndvLED.ZIndex = 10;
                _CorsairKeyboardIndvLED.Brush = _CorsairKeyboardIndvBrush;
                _CorsairAllKeyboardLED.Brush = (SolidColorBrush) Color.Black;

                _CorsairMouseIndvBrush = new KeyMapBrush();
                _CorsairMouseIndvLED = new ListLedGroup(CueSDK.MouseSDK, CueSDK.MouseSDK);
                _CorsairAllMouseLED = new ListLedGroup(CueSDK.MouseSDK, CueSDK.MouseSDK);
                _CorsairAllMouseLED.ZIndex = 1;
                _CorsairMouseIndvLED.ZIndex = 10;
                _CorsairMouseIndvLED.Brush = _CorsairMouseIndvBrush;
                _CorsairAllMouseLED.Brush = (SolidColorBrush) Color.Black;

                _CorsairMousepadIndvBrush = new KeyMapBrush();
                _CorsairMousepadIndvLED = new ListLedGroup(CueSDK.MousematSDK, CueSDK.MousematSDK);
                _CorsairAllMousepadLED = new ListLedGroup(CueSDK.MousematSDK, CueSDK.MousematSDK);
                _CorsairAllMousepadLED.ZIndex = 1;
                _CorsairMousepadIndvLED.ZIndex = 10;
                _CorsairMousepadIndvLED.Brush = _CorsairMousepadIndvBrush;
                _CorsairAllMousepadLED.Brush = (SolidColorBrush) Color.Black;

                _CorsairAllHeadsetLED = new ListLedGroup(CueSDK.HeadsetSDK, CueSDK.HeadsetSDK);
                _CorsairAllHeadsetLED.ZIndex = 1;
                _CorsairAllHeadsetLED.Brush = (SolidColorBrush) Color.Black;

                WriteConsole(ConsoleTypes.CORSAIR,
                    "CUE SDK Loaded (" + CueSDK.ProtocolDetails.SdkVersion + "/" + CueSDK.ProtocolDetails.ServerVersion +
                    ")");
            }
            catch (Exception ex)
            {
                WriteConsole(ConsoleTypes.CORSAIR, "CUE SDK failed to load. EX: " + ex.Message);
                CorsairSDK = false;
            }


            if (CorsairSDK)
            {
                CorsairSDKCalled = 1;
                CueSDK.UpdateMode = UpdateMode.Continuous;
                ResetCorsairDevices();
            }
        }

        public void ResetCorsairDevices()
        {
            if (CorsairSDK)
            {
                //Handled by file operations

                /*
                CorsairDeviceKeyboard = true;
                CorsairDeviceKeypad = false; //Not Implemented
                CorsairDeviceMouse = true;
                CorsairDeviceMousepad = true;
                CorsairDeviceHeadset = true;
                */

                CorsairDeviceKeypad = false; //Not Implemented
            }
            else
            {
                CorsairDeviceKeyboard = false;
                CorsairDeviceKeypad = false; //Not Implemented
                CorsairDeviceMouse = false;
                CorsairDeviceMousepad = false;
                CorsairDeviceHeadset = false;
            }

            ResetDeviceDataGrid();
        }


        public void CorsairUpdateLED()
        {
            if (CorsairSDK)
            {
                if (CorsairDeviceHeadset) CueSDK.HeadsetSDK.Update();
                if (CorsairDeviceKeyboard) CueSDK.KeyboardSDK.Update();
                if (CorsairDeviceMouse) CueSDK.MouseSDK.Update();
                if (CorsairDeviceMousepad) CueSDK.MousematSDK.Update();
            }
        }

        public void CorsairUpdateState(string type, Color col, bool disablekeys, [Optional] Color col2,
            [Optional] bool direction, [Optional] int speed)
        {
            MemoryTasks.Cleanup();
            //SolidColorBrush _CorsairAllLEDBrush = new SolidColorBrush(col);


            if (type == "reset")
            {
                if (CorsairSDK)
                    try
                    {
                        if (CorsairDeviceHeadset)
                        {
                            //
                        }
                        if (CorsairDeviceKeyboard && disablekeys != true)
                        {
                            //
                        }
                        if (CorsairDeviceKeypad)
                        {
                            //Not Implemented
                        }
                        if (CorsairDeviceMouse)
                        {
                            //
                        }
                        if (CorsairDeviceMousepad)
                        {
                            //
                        }
                    }
                    catch
                    {
                    }
            }
            else if (type == "static")
            {
                if (CorsairSDK)
                    try
                    {
                        if (CorsairDeviceHeadset)
                            _CorsairAllHeadsetLED.Brush = (SolidColorBrush) col;
                        if (CorsairDeviceKeyboard && disablekeys != true)
                        {
                            _CorsairAllKeyboardLED.Brush = (SolidColorBrush) col;
                            CueSDK.KeyboardSDK.Update();
                        }
                                
                        if (CorsairDeviceKeypad)
                        {
                            //Not Implemented
                        }
                        if (CorsairDeviceMouse)
                            _CorsairAllMouseLED.Brush = (SolidColorBrush) col;
                        if (CorsairDeviceMousepad)
                            _CorsairAllMousepadLED.Brush = (SolidColorBrush) col;
                    }
                    catch (Exception ex)
                    {
                        WriteConsole(ConsoleTypes.ERROR, "Corsair (Static)" + ex.Message);
                    }
            }
            else if (type == "transition")
            {
                if (CorsairSDK)
                {
                    var _CrSt = new Task(() =>
                    {
                        if (CorsairDeviceHeadset)
                        {
                            //CueSDK.HeadsetSDK.Brush = (SolidColorBrush)col;
                            //_CorsairAllHeadsetLED.Brush = _CorsairAllLEDBrush;
                            //_CorsairAllHeadsetLED.ZIndex = 1;
                            //CueSDK.HeadsetSDK.Update();
                        }
                        if (CorsairDeviceKeyboard && disablekeys != true)
                        {
                            //Corsairtransition(col, direction);
                        }
                        if (CorsairDeviceKeypad)
                        {
                            //Not Implemented
                        }
                        if (CorsairDeviceMouse)
                        {
                            //CueSDK.MouseSDK.Brush = (SolidColorBrush)col;
                            //_CorsairAllMouseLED.Brush = _CorsairAllLEDBrush;
                            //_CorsairAllMouseLED.ZIndex = 1;
                            //CueSDK.MouseSDK.Update();
                        }
                        if (CorsairDeviceMousepad)
                        {
                            //CueSDK.MousematSDK.Brush = (SolidColorBrush)col;
                            //_CorsairAllMousepadLED.Brush = _CorsairAllLEDBrush;
                            //_CorsairAllMousepadLED.ZIndex = 1;
                            //CueSDK.MousematSDK.Update();
                        }
                    });
                    MemoryTasks.Add(_CrSt);
                    MemoryTasks.Run(_CrSt);
                }
            }
            else if (type == "wave")
            {
                if (CorsairSDK)
                {
                    var _CrSt = new Task(() =>
                    {
                        try
                        {
                            if (CorsairDeviceHeadset)
                            {
                                //Headset.Instance.SetEffect(Corale.Colore.Corsair.Headset.Effects.Effect.SpectrumCycling);
                            }
                            if (CorsairDeviceKeyboard && disablekeys != true)
                            {
                                //Keyboard.Instance.SetWave(Corale.Colore.Corsair.Keyboard.Effects.Direction.LeftToRight);
                            }
                            if (CorsairDeviceKeypad)
                            {
                                //Not Implemented
                            }
                            if (CorsairDeviceMouse)
                            {
                                //Mouse.Instance.SetWave(Corale.Colore.Corsair.Mouse.Effects.Direction.FrontToBack);
                            }
                            if (CorsairDeviceMousepad)
                            {
                                //Mousepad.Instance.SetWave(Corale.Colore.Corsair.Mousepad.Effects.Direction.LeftToRight);
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine("Corsair (Wave): " + ex.Message);
                        }
                    });
                    MemoryTasks.Add(_CrSt);
                    MemoryTasks.Run(_CrSt);
                }
            }
            else if (type == "breath")
            {
                if (CorsairSDK)
                {
                    var _CrSt = new Task(() =>
                    {
                        try
                        {
                            if (CorsairDeviceHeadset)
                            {
                                //Headset.Instance.SetBreathing(RzCol);
                            }
                            if (CorsairDeviceKeypad)
                            {
                                //Keypad.Instance.SetBreathing(RzCol, RzCol2);
                            }
                            if (CorsairDeviceMouse)
                            {
                                //Mouse.Instance.SetBreathing(RzCol, RzCol2, Led.Backlight);
                                //Mouse.Instance.SetBreathing(RzCol, RzCol2, Led.Logo);
                                //Mouse.Instance.SetBreathing(RzCol, RzCol2, Led.ScrollWheel);
                            }
                            if (CorsairDeviceMousepad)
                            {
                                //Mousepad.Instance.SetBreathing(RzCol, RzCol2);
                            }
                            if (CorsairDeviceKeyboard && disablekeys != true)
                            {
                                //Keyboard.Instance.SetBreathing(RzCol, RzCol2);
                            }
                        }
                        catch (Exception ex)
                        {
                            WriteConsole(ConsoleTypes.ERROR, "Corsair (Breath): " + ex.Message);
                        }
                    });
                    MemoryTasks.Add(_CrSt);
                    MemoryTasks.Run(_CrSt);
                }
            }
            else if (type == "pulse")
            {
                if (CorsairSDK)
                {
                    var _CrSt = new Task(() =>
                    {
                        if (CorsairDeviceHeadset)
                            _CorsairAllHeadsetLED.Brush = (SolidColorBrush) col;
                        if (CorsairDeviceKeyboard && disablekeys != true)
                        {
                            //CorsairtransitionConst(col, col2, true, speed);
                        }
                        if (CorsairDeviceKeypad)
                        {
                            //Not Implemented
                        }
                        if (CorsairDeviceMouse)
                            _CorsairAllMouseLED.Brush = (SolidColorBrush) col;
                        if (CorsairDeviceMousepad)
                            _CorsairAllMousepadLED.Brush = (SolidColorBrush) col;
                    }, CCTS.Token);
                    MemoryTasks.Add(_CrSt);
                    MemoryTasks.Run(_CrSt);
                    //RzPulse = true;
                }
            }

            //CorsairUpdateLED();
            MemoryTasks.Cleanup();
        }

        public void CorsairApplyMapKeyLighting(string key, Color col, bool clear)
        {
            if (CorsairSDK)
                if (CorsairDeviceKeyboard)
                    if (Corsairkeyids.ContainsKey(key))
                        _CorsairKeyboardIndvBrush.CorsairApplyMapKeyLighting(Corsairkeyids[key], col);
        }

        public void CorsairApplyMapMouseLighting(string region, Color col, bool clear)
        {
            if (CorsairSDK)
                if (CorsairDeviceMouse)
                    if (Corsairkeyids.ContainsKey(region))
                        _CorsairMouseIndvBrush.CorsairApplyMapKeyLighting(Corsairkeyids[region], col);
        }

        public void CorsairApplyMapLogoLighting(string key, Color col, bool clear)
        {
            //Not Implemented
        }

        public void CorsairApplyMapPadLighting(string region, Color col, bool clear)
        {
            if (CorsairSDK)
                if (CorsairDeviceMousepad)
                    if (Corsairkeyids.ContainsKey(region))
                        _CorsairMousepadIndvBrush.CorsairApplyMapKeyLighting(Corsairkeyids[region], col);
        }

        private void Corsairtransition(Color col, bool forward)
        {
            lock (_Corsairtransition)
            {
                if (CorsairDeviceKeyboard)
                {
                    //To be implemented

                    /*
                    RectangleF spot = new RectangleF(CueSDK.KeyboardSDK.DeviceRectangle.Width / 2f, CueSDK.KeyboardSDK.DeviceRectangle.Y / 2f, 160, 80);
                    PointF target = new PointF(spot.X, spot.Y);
                    RectangleLedGroup _CorsairKeyRec = new RectangleLedGroup(CueSDK.KeyboardSDK, spot);

                    for (uint c = 0; c < Corale.Colore.Razer.Keyboard.Constants.MaxColumns; c++)
                    {
                        for (uint r = 0; r < Corale.Colore.Razer.Keyboard.Constants.MaxRows; r++)
                        {
                            var row = (forward) ? r : Corale.Colore.Razer.Keyboard.Constants.MaxRows - r - 1;
                            var colu = (forward) ? c : Corale.Colore.Razer.Keyboard.Constants.MaxColumns - c - 1;
                            Keyboard.Instance[Convert.ToInt32(row), Convert.ToInt32(colu)] = RzCol;
                        }
                        Thread.Sleep(15);
                    }
                    */
                }
            }
        }

        public void CorsairRipple1(Color burstcol, int speed, Color _BaseColor)
        {
            lock (_CorsairRipple1)
            {
                if (CorsairDeviceKeyboard)
                {
                    var presets = new Dictionary<string, Color>();

                    for (var i = 0; i <= 9; i++)
                    {
                        if (i == 0)
                        {
                            //Setup

                            foreach (var key in _Corsairkeys)
                                try
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                    {
                                        var _key = Corsairkeyids[key];
                                        Color ccX = CueSDK.KeyboardSDK[_key].Color;
                                        presets.Add(key, ccX);
                                    }
                                }
                                catch (Exception ex)
                                {
                                    WriteConsole(ConsoleTypes.ERROR, "(" + key + "): " + ex.Message);
                                }

                            //Keyboard.Instance.SetCustom(keyboard_custom);

                            HoldReader = true;
                        }
                        else if (i == 1)
                        {
                            //Step 0
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep0, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 2)
                        {
                            //Step 1
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep1, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 3)
                        {
                            //Step 2
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep2, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 4)
                        {
                            //Step 3
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep3, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 5)
                        {
                            //Step 4
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep4, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 6)
                        {
                            //Step 5
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep5, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 7)
                        {
                            //Step 6
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep6, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 8)
                        {
                            //Step 7
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep7, key);
                                if (pos > -1)
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                                else
                                {
                                    if (Corsairkeyids.ContainsKey(key))
                                        CorsairApplyMapKeyLighting(key, presets[key], false);
                                }
                            }
                        }
                        else if (i == 9)
                        {
                            //Spin down

                            foreach (var key in _Corsairkeys)
                                if (Corsairkeyids.ContainsKey(key))
                                    CorsairApplyMapKeyLighting(key, presets[key], false);

                            CorsairApplyMapKeyLighting("D1", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D2", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D3", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D4", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D5", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D6", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D7", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D8", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D9", _BaseColor, false);
                            CorsairApplyMapKeyLighting("D0", _BaseColor, false);
                            CorsairApplyMapKeyLighting("OemMinus", _BaseColor, false);
                            CorsairApplyMapKeyLighting("OemEquals", _BaseColor, false);

                            //presets.Clear();
                            HoldReader = false;
                        }

                        if (i < 9)
                            Thread.Sleep(speed);

                        CueSDK.KeyboardSDK.Update();
                    }
                }
            }
        }

        public void CorsairRipple2(Color burstcol, int speed)
        {
            lock (_CorsairRipple2)
            {
                if (CorsairDeviceKeyboard)
                {
                    var presets = new Dictionary<string, Color>();
                    //uint burstcol = new Corale.Colore.Core.Color(RzCol.R, RzCol.G, RzCol.B);

                    for (var i = 0; i <= 9; i++)
                    {
                        if (i == 0)
                        {
                            //Setup

                            foreach (var key in _Corsairkeys)
                            {
                                var _key = Corsairkeyids[key];
                                Color ccX = CueSDK.KeyboardSDK[_key].Color;
                                presets.Add(key, ccX);
                            }

                            //Keyboard.Instance.SetCustom(keyboard_custom);

                            HoldReader = true;
                        }
                        else if (i == 1)
                        {
                            //Step 0
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep0, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 2)
                        {
                            //Step 1
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep1, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 3)
                        {
                            //Step 2
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep2, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 4)
                        {
                            //Step 3
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep3, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 5)
                        {
                            //Step 4
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep4, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 6)
                        {
                            //Step 5
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep5, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 7)
                        {
                            //Step 6
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep6, key);
                                if (pos > -1)
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                            }
                        }
                        else if (i == 8)
                        {
                            //Step 7
                            foreach (var key in _Corsairkeys)
                            {
                                var pos = Array.IndexOf(_Corsairstep7, key);
                                if (pos > -1)
                                {
                                    CorsairApplyMapKeyLighting(key, burstcol, false);
                                }
                            }
                        }
                        else if (i == 9)
                        {
                            //Spin down

                            foreach (var key in _Corsairkeys)
                            {
                                //CorsairApplyMapKeyLighting(key, presets[key], false);
                            }


                            //presets.Clear();
                            HoldReader = false;
                        }

                        if (i < 9)
                            Thread.Sleep(speed);
                    }
                }
            }
        }

        public void CorsairFlash1(Color burstcol, int speed)
        {
            lock (_CorsairFlash1)
            {
                var presets = new Dictionary<string, Color>();
                var ScrollWheel = new Color();
                var Logo = new Color();
                var Backlight = new Color();

                var ScrollWheelConv = ScrollWheel;
                var LogoConv = Logo;
                var BacklightConv = Backlight;

                for (var i = 0; i <= 8; i++)
                {
                    if (i == 0)
                    {
                        //Setup
                        if (CorsairDeviceKeyboard)
                            foreach (var key in _Corsairkeys3)
                            {
                                var _key = Corsairkeyids[key];
                                Color ccX = CueSDK.KeyboardSDK[_key].Color;
                                presets.Add(key, ccX);
                            }

                        if (CorsairDeviceMouse)
                        {
                            ScrollWheel = CueSDK.MouseSDK[CorsairLedId.B3].Color;
                            Logo = CueSDK.MouseSDK[CorsairLedId.B1].Color;
                            Backlight = CueSDK.MouseSDK[CorsairLedId.B4].Color;
                        }

                        //Keyboard.Instance.SetCustom(keyboard_custom);

                        HoldReader = true;
                    }
                    else if (i == 1)
                    {
                        //Step 0
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, burstcol, false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", burstcol, false);
                                CorsairApplyMapMouseLighting("Logo", burstcol, false);
                                CorsairApplyMapMouseLighting("Backlight", burstcol, false);
                            }
                        }
                    }
                    else if (i == 2)
                    {
                        //Step 1
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, presets[key], false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", ScrollWheelConv, false);
                                CorsairApplyMapMouseLighting("Logo", LogoConv, false);
                                CorsairApplyMapMouseLighting("Backlight", BacklightConv, false);
                            }
                        }
                    }
                    else if (i == 3)
                    {
                        //Step 2
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, burstcol, false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", burstcol, false);
                                CorsairApplyMapMouseLighting("Logo", burstcol, false);
                                CorsairApplyMapMouseLighting("Backlight", burstcol, false);
                            }
                        }
                    }
                    else if (i == 4)
                    {
                        //Step 3
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, presets[key], false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", ScrollWheelConv, false);
                                CorsairApplyMapMouseLighting("Logo", LogoConv, false);
                                CorsairApplyMapMouseLighting("Backlight", BacklightConv, false);
                            }
                        }
                    }
                    else if (i == 5)
                    {
                        //Step 4
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, burstcol, false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", burstcol, false);
                                CorsairApplyMapMouseLighting("Logo", burstcol, false);
                                CorsairApplyMapMouseLighting("Backlight", burstcol, false);
                            }
                        }
                    }
                    else if (i == 6)
                    {
                        //Step 5
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, presets[key], false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", ScrollWheelConv, false);
                                CorsairApplyMapMouseLighting("Logo", LogoConv, false);
                                CorsairApplyMapMouseLighting("Backlight", BacklightConv, false);
                            }
                        }
                    }
                    else if (i == 7)
                    {
                        //Step 6
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, burstcol, false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", burstcol, false);
                                CorsairApplyMapMouseLighting("Logo", burstcol, false);
                                CorsairApplyMapMouseLighting("Backlight", burstcol, false);
                            }
                        }
                    }
                    else if (i == 8)
                    {
                        //Step 7
                        foreach (var key in _Corsairkeys3)
                        {
                            if (CorsairDeviceKeyboard)
                                CorsairApplyMapKeyLighting(key, presets[key], false);
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("ScrollWheel", ScrollWheelConv, false);
                                CorsairApplyMapMouseLighting("Logo", LogoConv, false);
                                CorsairApplyMapMouseLighting("Backlight", BacklightConv, false);
                            }
                        }

                        HoldReader = false;
                    }

                    if (i < 8)
                        Thread.Sleep(speed);
                }
            }
        }

        public void CorsairFlash2(Color burstcol, int speed)
        {
            lock (_CorsairFlash2)
            {
                if (_CorsairFlash2Running == false)
                {
                    if (CorsairDeviceMouse)
                    {
                        //CorsairScrollWheel = CueSDK.MouseSDK[CorsairLedId.B3].Color;
                        CorsairScrollWheel = CueSDK.MouseSDK[CorsairLedId.B3].Color;
                        CorsairLogo = CueSDK.MouseSDK[CorsairLedId.B1].Color;

                        CorsairScrollWheelConv = CorsairScrollWheel;
                        CorsairLogoConv = CorsairLogo;
                    }

                    if (CorsairDeviceKeyboard)
                    {
                        CorsairPrintScr = CueSDK.KeyboardSDK[CorsairLedId.PrintScreen].Color;
                        CorsairScrollLk = CueSDK.KeyboardSDK[CorsairLedId.ScrollLock].Color;
                        CorsairPauseBrk = CueSDK.KeyboardSDK[CorsairLedId.PauseBreak].Color;

                        CorsairPrintScrConv = CorsairPrintScr;
                        CorsairScrollLkConv = CorsairScrollLk;
                        CorsairPauseBrkConv = CorsairPauseBrk;
                    }

                    _CorsairFlash2Running = true;
                }
                else
                {
                    while (_CorsairFlash2Running)
                        if (_CorsairFlash2Step == 0)
                        {
                            if (CorsairDeviceKeyboard)
                            {
                                CorsairApplyMapKeyLighting("PrintScreen", burstcol, false);
                                CorsairApplyMapKeyLighting("Scroll", burstcol, false);
                                CorsairApplyMapKeyLighting("Pause", burstcol, false);
                            }
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("CorsairScrollWheel", burstcol, false);
                                CorsairApplyMapMouseLighting("Logo", burstcol, false);
                            }
                            _CorsairFlash2Step = 1;

                            Thread.Sleep(speed);
                        }
                        else if (_CorsairFlash2Step == 1)
                        {
                            if (CorsairDeviceKeyboard)
                            {
                                CorsairApplyMapKeyLighting("PrintScreen", CorsairPrintScrConv, false);
                                CorsairApplyMapKeyLighting("Scroll", CorsairScrollLkConv, false);
                                CorsairApplyMapKeyLighting("Pause", CorsairPauseBrkConv, false);
                            }
                            if (CorsairDeviceMouse)
                            {
                                CorsairApplyMapMouseLighting("CorsairScrollWheel", CorsairScrollWheelConv, false);
                                CorsairApplyMapMouseLighting("Logo", CorsairLogoConv, false);
                            }
                            _CorsairFlash2Step = 0;

                            Thread.Sleep(speed);
                        }
                }
            }
        }

        public void CorsairtransitionConst(Color col1, Color col2, bool forward, int speed)
        {
            lock (_CorsairtransitionConst)
            {
                //To be implemented
            }
        }
    }
}